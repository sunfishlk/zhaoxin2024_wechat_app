"use strict";const e=require("../../common/vendor.js"),a=require("../../utils/log.js"),t={__name:"message-confirm",setup(t){const o=getApp().globalData.baseUrl,n=e.ref({name:"",college:"",studentNumber:"",phoneNumber:"",email:"",mainDepartment:"",otherDepartment:"",skills:"",wantToLearn:"",schoolArea:"",date:"",time:"",position:"",whereKnow:""}),s=()=>new Promise(((a,t)=>{e.index.login({provider:"weixin",success:e=>{e.code?(console.log("登录 code:",e.code),a(e.code)):(console.log("登录失败！"+e.errMsg),t(new Error("登录失败！"+e.errMsg)))},fail:e=>{console.log(e),t(e)}})})),l=()=>{let t=e.index.getStorageSync("cookie");console.log(t);let l=(r=n.value.date,c=n.value.time,`2024-${r}T${c}:00.00+08:00`);var r,c;console.log(l),console.log({name:n.value.name,mainde:n.value.mainDepartment,time:l,netid:n.value.studentNumber,secondary:n.value.otherDepartment,Phone:n.value.phoneNumber,mail:n.value.email,already:n.value.skills,want:n.value.wantToLearn,whereknow:n.value.whereKnow,clazz:n.value.college});const d=(o,n)=>new Promise(((s,l)=>{e.index.request({url:o,method:"PUT",header:{"Content-Type":"application/json",Cookie:t},data:n,success:t=>{a.log.info({requestData:{data:n},responseData:t}),console.log(t),!1===t.data.success?(e.index.showToast({title:t.data.message,icon:"none",duration:2e3}),console.log(t.data.message),l(t.data.message)):s(t)},fail:e=>{console.log(e),l(e)}})}));d(`${o}/api/student/info`,{name:n.value.name,time:l,netid:n.value.studentNumber,Phone:n.value.phoneNumber,mail:n.value.email,already:n.value.skills,want:n.value.wantToLearn,whereknow:n.value.whereKnow,clazz:n.value.college}).then((e=>{if(e.data.success){return d(`${o}/api/student/itv`,{time:l,department:n.value.mainDepartment,secondary:n.value.otherDepartment})}throw new Error(e.data.message)})).then((a=>{if(!a.data.success)throw new Error(a.data.message);e.index.showToast({title:"提交成功",icon:"success",duration:2e3}),i()})).catch((async t=>{await(async()=>{let t="",n="";try{t=await s(),n=await s(),console.log(t),console.log(n)}catch(l){console.log(l)}t?e.index.request({url:`${o}/api/student`,method:"POST",data:{code:t},success:async o=>{if(a.log.info({requestData:{code:t},responseData:o}),console.log(o),console.log(t),e.index.setStorageSync("cookie",o.cookies[0]),!1===o.data.success)return console.log(o.data.message),void e.index.showToast({title:o.data.message,icon:"none",duration:2e3});if(o.data.data.is_first);else{console.log(o),e.index.setStorageSync("studentNumber",o.data.data.stuinfo.netid),e.index.setStorageSync("name",o.data.data.stuinfo.name),e.index.setStorageSync("phoneNumber",o.data.data.stuinfo.phone),e.index.setStorageSync("email",o.data.data.stuinfo.mail),e.index.setStorageSync("mainDepartment",o.data.data.stuinfo.mainde),e.index.setStorageSync("otherDepartment",o.data.data.stuinfo.secondary),e.index.setStorageSync("skills",o.data.data.stuinfo.already),e.index.setStorageSync("wantToLearn",o.data.data.stuinfo.want),e.index.setStorageSync("whereKnow",o.data.data.stuinfo.whereknow),e.index.setStorageSync("college",o.data.data.stuinfo.clazz);let a=o.data.data.stuinfo.time;if(null===a);else{const t=e=>{let[a,t]=e.split("T"),[o,n]=t.split(":"),[s,l,i]=a.split("-");return{date:`${l}-${i}`,time:`${o}:${n}`}};e.index.setStorageSync("date",t(a).date),e.index.setStorageSync("time",t(a).time),console.log(a),console.log(t(a).date),console.log(t(a).time)}}},fail:a=>{console.log(a),e.index.showToast({title:JSON.stringify(a),icon:"none"})}}):console.log("登录 code 不存在")})(),console.log(t)}))},i=async()=>{const t="nQrZdlf6tFtAyiHjvjtFHsKMAWICDvvmYVpP2448-0M",n="EkFzf-rthPh8QVXvTaH-dhnWkeSg1wWodVhn044cJWA",s="SjIczANpmNHE8I8AKisDK3zWqQauGfm9F5X7PTFk4PY";e.wx$1.requestSubscribeMessage({tmplIds:[t,n,s],success:l=>{console.log(l);let i={register:"accept"===l[t]?1:0,itvTime:"accept"===l[n]?1:0,itvRes:"accept"===l[s]?1:0},r=e.index.getStorageSync("cookie");e.index.request({url:`${o}/api/student/submsg`,method:"PUT",header:{"Content-Type":"application/json",Cookie:r},data:i,success:t=>{a.log.info({requestData:{state:i},responseData:t}),console.log(t),e.index.reLaunch({url:"/pages/color-egg/color-egg"})},fail:a=>{console.log(a),e.index.showToast({title:JSON.stringify(a),icon:"none"})}})},fail:a=>{console.log(a),e.index.showToast({title:JSON.stringify(a),icon:"none"})}})},r=e.ref(!1);e.onMounted((()=>{n.value.name=e.index.getStorageSync("name"),n.value.college=e.index.getStorageSync("college"),n.value.studentNumber=e.index.getStorageSync("studentNumber"),n.value.phoneNumber=e.index.getStorageSync("phoneNumber"),n.value.email=e.index.getStorageSync("email"),n.value.mainDepartment=e.index.getStorageSync("mainDepartment"),n.value.otherDepartment=e.index.getStorageSync("otherDepartment"),n.value.skills=e.index.getStorageSync("skills"),n.value.wantToLearn=e.index.getStorageSync("wantToLearn"),n.value.schoolArea=e.index.getStorageSync("schoolArea"),n.value.date=e.index.getStorageSync("date"),n.value.time=e.index.getStorageSync("time"),n.value.position=e.index.getStorageSync("position"),n.value.whereKnow=e.index.getStorageSync("whereKnow"),e.index.request({url:`${o}/api/version?version=1`,method:"GET",success:t=>{a.log.info({responseData:t}),!1===t.data.success?e.index.showToast({title:t.data.message,icon:"none"}):!0===t.data.data.formal?r.value=!0:r.value=!1},fail:a=>{console.log(a),e.index.showToast({title:JSON.stringify(a),icon:"none"})}})}));const c=a=>{e.index.navigateBack({delta:a})};return(a,t)=>e.e({a:!r.value},r.value?{}:{b:e.t(n.value.name),c:e.o((e=>c(5)))},{d:e.t(n.value.college),e:e.o((e=>c(5))),f:!r.value},r.value?{}:{g:e.t(n.value.phoneNumber),h:e.o((e=>c(5)))},{i:!r.value},r.value?{}:{j:e.t(n.value.email),k:e.o((e=>c(5)))},{l:e.t(n.value.whereKnow),m:e.o((e=>c(5))),n:e.t(n.value.mainDepartment),o:e.o((e=>c(4))),p:e.t(n.value.otherDepartment),q:e.o((e=>c(3))),r:e.t(n.value.skills),s:e.o((e=>c(2))),t:e.t(n.value.wantToLearn),v:e.o((e=>c(2))),w:e.t(n.value.schoolArea),x:e.o((e=>c(1))),y:e.t(n.value.position),z:e.o((e=>c(1))),A:e.t(n.value.date),B:e.o((e=>c(1))),C:e.t(n.value.time),D:e.o((e=>c(1))),E:e.o(l)})}},o=e._export_sfc(t,[["__scopeId","data-v-0649e3da"]]);wx.createPage(o);
