"use strict";const e=require("../../common/vendor.js"),t=require("../../utils/log.js"),a={__name:"login",setup(a){const o=e.ref(""),n=getApp().globalData.baseUrl,s=()=>new Promise(((t,a)=>{e.index.login({provider:"weixin",success:e=>{e.code?(console.log("登录 code:",e.code),t(e.code)):(console.log("登录失败！"+e.errMsg),a(new Error("登录失败！"+e.errMsg)))},fail:e=>{console.log(e),a(e)}})})),i=async()=>{if(c.value)try{let a=await s();console.log("login"),e.index.setStorageSync("studentNumber",o.value),console.log(o.value),e.index.request({url:`${n}/api/student`,method:"POST",data:{code:a,netid:o.value},success:n=>{if(t.log.info({requestData:{code:a,netid:o.value},responseData:n}),console.log(n),!1===n.data.success)e.index.showToast({title:n.data.message,icon:"none",duration:2e3});else{e.index.setStorageSync("studentNumber",n.data.data.stuinfo.netid),e.index.setStorageSync("name",n.data.data.stuinfo.name),e.index.setStorageSync("phoneNumber",n.data.data.stuinfo.phone),e.index.setStorageSync("email",n.data.data.stuinfo.mail),e.index.setStorageSync("mainDepartment",n.data.data.stuinfo.mainde),e.index.setStorageSync("otherDepartment",n.data.data.stuinfo.secondary),e.index.setStorageSync("skills",n.data.data.stuinfo.already),e.index.setStorageSync("wantToLearn",n.data.data.stuinfo.want),e.index.setStorageSync("whereKnow",n.data.data.stuinfo.whereknow),e.index.setStorageSync("college",n.data.data.stuinfo.clazz);let t=n.data.data.stuinfo.time;if(null===t);else{const a=e=>{let[t,a]=e.split("T"),[o,n]=a.split(":"),[s,i,d]=t.split("-");return{date:`${i}-${d}`,time:`${o}:${n}`}};e.index.setStorageSync("date",a(t).date),e.index.setStorageSync("time",a(t).time),console.log(t),console.log(a(t).date),console.log(a(t).time)}null===t||"0001-01-01T00:00:00Z"===t?e.index.redirectTo({url:"/pages/home/home"}):e.index.redirectTo({url:"/pages/color-egg/color-egg"}),e.index.setStorageSync("studentNumber",o.value),e.index.setStorageSync("cookie",n.cookies[0])}},fail:t=>{console.log(t),e.index.showToast({title:JSON.stringify(t),icon:"none"})}})}catch(a){console.error("获取 code 或登录失败",a),e.index.showToast({title:JSON.stringify(a),icon:"none",duration:2e3})}else e.index.showToast({title:"学号格式或长度错误",icon:"none",duration:2e3})},d=e.ref(!1),l=e=>new Promise((t=>setTimeout(t,e)));e.onShow((async()=>{await(async()=>{let a="";try{a=await s(),console.log(a)}catch(o){console.log(o)}a?e.index.request({url:`${n}/api/student`,method:"POST",data:{code:a},success:async o=>{if(t.log.info({requestData:{code:a},responseData:o}),e.index.clearStorageSync(),console.log(o),console.log(a),e.index.setStorageSync("cookie",o.cookies[0]),d.value=!0,!1===o.data.success)return console.log(o.data.message),void e.index.showToast({title:o.data.message,icon:"none",duration:2e3});if(o.data.data.is_first)await l(1e3),S(),console.log("首次登录,清空localStorage");else{console.log(o),e.index.setStorageSync("studentNumber",o.data.data.stuinfo.netid),e.index.setStorageSync("name",o.data.data.stuinfo.name),e.index.setStorageSync("phoneNumber",o.data.data.stuinfo.phone),e.index.setStorageSync("email",o.data.data.stuinfo.mail),e.index.setStorageSync("mainDepartment",o.data.data.stuinfo.mainde),e.index.setStorageSync("otherDepartment",o.data.data.stuinfo.secondary),e.index.setStorageSync("skills",o.data.data.stuinfo.already),e.index.setStorageSync("wantToLearn",o.data.data.stuinfo.want),e.index.setStorageSync("whereKnow",o.data.data.stuinfo.whereknow),e.index.setStorageSync("college",o.data.data.stuinfo.clazz);let t=o.data.data.stuinfo.time;if(null===t);else{const a=e=>{let[t,a]=e.split("T"),[o,n]=a.split(":"),[s,i,d]=t.split("-");return{date:`${i}-${d}`,time:`${o}:${n}`}};e.index.setStorageSync("date",a(t).date),e.index.setStorageSync("time",a(t).time),console.log(t),console.log(a(t).date),console.log(a(t).time)}await l(1e3),null===t||"0001-01-01T00:00:00Z"===t?e.index.redirectTo({url:"/pages/home/home"}):e.index.redirectTo({url:"/pages/color-egg/color-egg"})}},fail:t=>{console.log(t),e.index.showToast({title:JSON.stringify(t),icon:"none"})}}):console.log("登录 code 不存在")})()}));const r=e.ref(["input-rule","un-show"]);const c=e.computed((()=>{return e=o.value,/^\d{10}$/.test(e);var e})),u=()=>{console.log(o.value),console.log(c.value),c.value?r.value=["input-rule","un-show"]:r.value=["input-rule"]},g=e.ref(!0),S=()=>{console.log("hideLogo"),g.value=!1};return(t,a)=>({a:e.n({animation:d.value}),b:g.value?"":"none",c:e.o(u),d:o.value,e:e.o((e=>o.value=e.detail.value)),f:e.n(r.value),g:e.o(i),h:e.o(((...e)=>t.next&&t.next(...e))),i:g.value?"none":""})}},o=e._export_sfc(a,[["__scopeId","data-v-868d801e"]]);wx.createPage(o);
